# Chat Log Maker 仕様書 v2.0

## 概要

Obsidian の Markdown ファイル内に記述された特別なコードブロック（chat）を解析し、視覚的に分かりやすいチャット UI としてサイドパネルに表示するプラグイン。登場人物の名前変更や、編集結果を Markdown としてエクスポートする機能も提供する。

## 基本コンセプト

■ 入力: `chat` コードブロック

```md
# チームミーティング

> Alice: 皆さん、お疲れ様です！
> Bob: お疲れ様！
>
> > Alice: ありがとうございます！
```

- `>>`で階層を表現
- `> >`のようにスペースが入ってもエラーを出さずにしたい
  - `>>`に統一したいけど自動整形でスペース入りがちなので、エラーにさせず対応範囲にしたい

■ 出力: インタラクティブなチャット UI

- 右側パネルに視覚的なチャット画面を表示
- 登場人物を自動でリスト化し、名前の編集が可能
- 返信構造（ネスト）を線で視覚的に表現
- UI 上での変更を反映した Markdown をエクスポート可能。

## 主要機能

### Markdown テキスト解析

- `chat` と指定されたコードブロック内を解析対象とする。

- `#`で始まる行をチャットタイトルとして解釈する。

- 引用記法（>）を使った行をメッセージとして解釈する。

- ネストした引用（>>, >>>...）を返信として解釈する。

- `> 名前: 内容` の形式から発言者を自動で検出する。
  - 名前がない場合は直前の会話の発言者の会話の続きと判定する

### UI 表示フロー

- ユーザーが `chat` コードブロックをクリックする。

- 右側にチャット UI パネルがスライドインで表示される。

- コードブロックの内容が自動で解析され、タイトル、登場人物、メッセージが UI に反映される。

### 登場人物の管理

- Markdown から検出された発言者は、登場順に A, B, C... という固定ラベルと共にリスト化される。

- ユーザーは UI 上で各登場人物の名前を自由に変更できる。

- 変更した名前は、チャットログの表示に即座に反映される。

- 登場人物の追加・削除も UI 上から可能。

### 返信の可視化

- メッセージ間の返信関係を、Reddit のような**縦線（スレッドライン）**で結んで表示する。

- 返信の階層が深くなるごとに、線の色が変わる。

- これにより、誰が誰に返信しているかが一目でわかる。

### Markdown エクスポート

- UI のヘッダーにある「エクスポート」ボタンを押すと、現在のチャット内容を Markdown 形式でクリップボードにコピーできる。

- その際、UI 上で編集された登場人物の名前が反映された状態で出力される。

## UI 構成

### メインパネル

┌─────────────────────────────────┐
│ Chat Log Preview [📋 エクスポート] [×] │
├─────────────────────────────────┤
│ 👥 登場人物 (固定高さ 150px) │
│ ┌───────────────────────────┐ │
│ │ A [ Alice ] [削除] │ │
│ └───────────────────────────┘ │
│ ┌───────────────────────────┐ │
│ │ B [ Bob ] [削除] │ │
│ └───────────────────────────┘ │
│ [ + 登場人物を追加 ] │
├─────────────────────────────────┤
│ 💬 チームミーティング (可変高さ) │
│ │ ┌─ Alice ──────────────┐ │
│ │ │ 皆さん、お疲れ様です！ │ │
│ │ └───────────────────────┘ │
│ │ ┌─ Bob ─────────────────┐ │
│ │ │ お疲れ様！ │ │
│ │ └───────────────────────┘ │
│ │ │ ┌─ Alice (返信) ────┐ │
│ │ │ │ ありがとうございます！│ │
│ │ │ └───────────────────┘ │
│ │ │
│ │ [スクロール可能エリア] │
├─────────────────────────────────┤
│ [リフレッシュ] (固定高さ 60px) │
└─────────────────────────────────┘

## Markdown 記法仕様

### 基本構造

チャットログは、言語指定が chat であるコードブロック内に記述する。

```md
# ここにタイトル

> ここにメッセージ
```

### タイトル記法

ブロック内の#で始まる最初の行がタイトルとなる。

例：

```md
# チームミーティング
```

### メッセージ記法

基本形式:

```md
> 発言者名: 発言内容
```

返信形式:

```md
> > 発言者名: 発言内容
```

`>` の数は返信の階層の深さに対応する。

### 発言者検出ルール

`> 名前:` の形式を自動検出する（コロンの前のスペースは任意）。

同じ名前は同一人物として扱われ、同じラベル（A, B, C...）が割り当てられる。

## データ構造

```ts
// 登場人物のデータ構造
interface Participant {
  label: string; // 'A', 'B', 'C'...
  originalName: string; // Markdown から最初に検出された名前
  displayName: string; // ユーザーが編集可能な表示名
}

// チャットメッセージのデータ構造
interface ChatMessage {
  authorLabel: string; // 'A', 'B', 'C'...
  content: string;
  replyLevel: number; // 0=トップレベル, 1=返信, 2=返信の返信...
}

// チャット全体のデータ構造
interface ChatData {
  title: string;
  messages: ChatMessage[];
  // Map<string, Participant> の形式で管理 (キーはラベル 'A', 'B'...)
  participants: Map<string, Participant>;
}
```
