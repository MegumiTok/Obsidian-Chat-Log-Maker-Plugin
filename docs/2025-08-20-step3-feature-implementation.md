# Chat Log Maker Plugin 開発 - Step 3: 機能実装

## 概要

Step2 で完成した縦 1 カラムレイアウトに、実際のチャット機能を実装する。Markdown パーサー、UI 編集機能、返信機能など、docs/mockup-v2.html で示された全ての機能を実装する。

## 優先順位（UI ファースト方針）

### Phase 1: UI 基本操作（最優先）

1. **登場人物の動的管理（実際のチャットとの連携）**（実装済み ✅）

   - メッセージ追加時の話者選択（セレクトボックス）
   - 新規話者の追加機能
   - 話者名の変更・削除
   - 話者とメッセージの連携

2. **UI 側からのチャット編集（インライン編集）**（実装済み ✅）

   - メッセージクリックで編集モード
   - テキストエリアでの直接編集
   - 保存・キャンセル機能

3. **UI 側からの返信機能**（実装済み ✅）
   - 返信ボタンの実装
   - 返信フォームの表示（話者選択含む）
   - ネストレベルの管理

### Phase 2: 登場人物管理

4. **登場人物の追加・削除**
   - 登場人物の追加ができるように
   - および、削除も
   - 返信メッセージ、新規メッセージ作成するときに登録してない登場人物は非表示に

### Phase 3: 永続化

5. **エクスポート機能**

   - エクスポート時、階層があれば適切に `>>` などで表現されている
   - 改行（Line Feed）も適切に扱えるように
   - 階層の分かりやすい表現
   - タイトル文字も `#` で出力されているように

6. **Markdown の chat コードブロック認識・解析**

   - 保存された Markdown から UI への復元
   - 初期データの読み込み
     - `chat`を認識できるようにする
   - UI のチャットと markdown が連動して同期できるか検討
     - 技術的に複雑になるようであれば、export 機能の活用やボタンを押した時だけリロードするなどの処理でも ok
     - できるだけシンプルな構造に保ちたい

### Phase 4

7. **リフレッシュ機能**
   - リフレッシュボタンを押したらチャットがクリア
   - その際、確認モーダルが出てるようにする
   - リフレッシュボタンを押したときに保存された markdown も一緒に消えるのは避けたいのでどういう構造にすべきか改めて検討

## 実装方針

### UI ファースト・手動操作重視

- **基本フロー**: 話者選択 → メッセージ入力 → 投稿 → 表示
- **mockup-v1.html 参考機能**:
  - 投稿フォームでの話者選択（セレクトボックス）
  - 返信時の話者選択機能
  - リアルタイムなメッセージ表示更新
- **mockup-v2.html 参考デザイン**:
  - 縦 1 カラムレイアウト
  - 登場人物セクション（150px 固定）
  - チャット表示エリア（可変高さ）

### シンプル設計原則

- **複雑な同期機能より確実に動く基本機能**
- **段階的拡張**: 基本機能 → 視覚化 → 永続化
- **バックアップ重視**: Markdown は「保存形式」として位置づけ
- **リロード許容**: 双方向同期は理想だが、最悪リロードで復元できれば OK

### 具体的な実装ポイント

#### 1. 投稿フォーム実装 (mockup-v1.html 参考)

- 話者選択セレクトボックス
- メッセージ入力テキストエリア
- 投稿ボタン
- 返信モード時の親メッセージ表示

#### 2. メッセージ管理

- メッセージ配列への追加・削除・編集
- 話者ラベル（A, B, C...）の自動割り当て
- ネストレベルの管理

#### 3. 登場人物管理

- 動的な話者追加・削除
- 話者名とラベルのマッピング
- 未使用話者の自動非表示
