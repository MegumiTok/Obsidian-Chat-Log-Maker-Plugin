# Chat Log Maker Plugin 開発 - Step 4-1: 登場人物管理の改善

## 概要

Phase 2 として登場人物管理機能を改善する。現在の実装では基本的な追加・削除機能はあるが、実際のチャット作成時に未使用の登場人物が選択肢に表示される問題と、登場人物削除時の安全性の向上が必要。

## 実装したいこと・課題

- 返信メッセージや新規メッセージ作成時に、実際にメッセージを投稿していない登場人物も選択肢に表示される
- 登場人物削除時の確認機能がない
- 削除対象の登場人物が既存メッセージで使用されている場合の処理が不適切
- メッセージ削除時の確認機能がない
- Markdown エクスポート時に階層表現（`>>`など）が正しく出力されない

## 方針

- 話者選択時に使用されていない登場人物を非表示にすることで、UI が整理される
- 削除時の確認ダイアログで誤削除を防げる
- 使用中の登場人物削除時は警告または削除禁止にすることで安全性が向上する
- 階層レベルに応じて`>`の数を調整することで、正しい Markdown 出力が可能

## やったこと

1. **話者選択の改善**: `updateSpeakerSelect`関数でメッセージ投稿実績のある登場人物を優先表示し、未使用の登場人物は区切り線の後に表示するロジックを実装
2. **登場人物削除時の確認ダイアログ**: 使用中の登場人物には警告メッセージ、未使用の登場人物にも念のため確認ダイアログを追加
3. **メッセージ削除時の確認ダイアログ**: メッセージ削除時に話者名と共に確認ダイアログを表示
4. **Markdown 生成の改善**: 階層レベル（`replyLevel`）に応じて`>`の数を調整する機能を実装
5. **話者選択の自動更新**: 投稿後に`updateSpeakerSelect`を呼び出して使用実績を反映

## TODO

- テスト用のサンプルデータでの動作確認
- リフレッシュ機能の実装（Phase 4）
- Markdown からの復元機能（Phase 3）
